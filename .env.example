# ============================================================================
# Stage 4 Clustering Service - Environment Variables Template
# ============================================================================
# Copy this file to .env and fill in your actual values
# DO NOT commit .env to version control
# ============================================================================

# -----------------------------------------------------------------------------
# Service Configuration
# -----------------------------------------------------------------------------
SERVICE_NAME=stage4-clustering
LOG_LEVEL=INFO
ENVIRONMENT=development

# -----------------------------------------------------------------------------
# Infrastructure Services (when using docker-compose.infrastructure.yml)
# -----------------------------------------------------------------------------
# Redis Broker (Celery)
REDIS_HOST=redis-broker
REDIS_PORT=6379
REDIS_DB=6  # Stage 4: (4-1)*2 = 6

# Redis Cache
REDIS_CACHE_HOST=redis-cache
REDIS_CACHE_PORT=6379
REDIS_CACHE_DB=7  # Stage 4: (4-1)*2+1 = 7

# PostgreSQL
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_DB=stage4_clustering
POSTGRES_USER=stage4_user
POSTGRES_PASSWORD=your_secure_password_here
STAGE4_POSTGRES_PASSWORD=your_secure_password_here

# -----------------------------------------------------------------------------
# Celery Configuration
# -----------------------------------------------------------------------------
CELERY_BROKER_URL=redis://redis-broker:6379/6
CELERY_RESULT_BACKEND=redis://redis-cache:6379/7
CELERY_WORKER_CONCURRENCY=22
CELERY_WORKER_PREFETCH_MULTIPLIER=1
CELERY_WORKER_MAX_TASKS_PER_CHILD=50

# -----------------------------------------------------------------------------
# Stage 3 Integration (Upstream Dependency)
# -----------------------------------------------------------------------------
STAGE3_API_URL=http://embeddings-orchestrator:8000
STAGE3_INDICES_PATH=/shared/stage3/data/vector_indices

# -----------------------------------------------------------------------------
# Inter-Stage Automation (Webhooks)
# -----------------------------------------------------------------------------
# Optional webhook authentication tokens for secure inter-stage communication
STAGE4_WEBHOOK_SECRET=your_stage4_webhook_secret_here
STAGE5_WEBHOOK_SECRET=your_stage5_webhook_secret_here

# Upstream automation (Stage 3 → Stage 4)
UPSTREAM_AUTOMATION_ENABLED=true
AUTO_TRIGGER_ENABLED=true
STAGE3_STREAM_NAME=stage3:embeddings:events

# Downstream automation (Stage 4 → Stage 5)
DOWNSTREAM_AUTOMATION_ENABLED=true
STAGE5_WEBHOOK_URL=http://graph-orchestrator:8000/webhooks/clustering-completed

# -----------------------------------------------------------------------------
# GPU Configuration
# -----------------------------------------------------------------------------
CUDA_VISIBLE_DEVICES=0
FAISS_USE_GPU=true
GPU_MEMORY_FRACTION=0.8

# -----------------------------------------------------------------------------
# Clustering Configuration
# -----------------------------------------------------------------------------
DEFAULT_ALGORITHM=hdbscan
MIN_CLUSTER_SIZE=5
MIN_SAMPLES=3
CLUSTER_SELECTION_EPSILON=0.0

# -----------------------------------------------------------------------------
# Observability
# -----------------------------------------------------------------------------
# OpenTelemetry
OTEL_EXPORTER_OTLP_ENDPOINT=http://tempo:4317
OTEL_SERVICE_NAME=stage4-clustering-orchestrator
OTEL_TRACES_EXPORTER=otlp
OTEL_METRICS_EXPORTER=otlp

# Prometheus
PROMETHEUS_PORT=9090

# -----------------------------------------------------------------------------
# API Configuration
# -----------------------------------------------------------------------------
API_HOST=0.0.0.0
API_PORT=8000
API_WORKERS=4
API_RELOAD=false

# CORS
CORS_ORIGINS=["http://localhost:3000","http://localhost:8080"]

# -----------------------------------------------------------------------------
# Job Lifecycle Configuration
# -----------------------------------------------------------------------------
ENABLE_JOB_QUEUE=true
MAX_CONCURRENT_JOBS=1
JOB_TTL_DAYS=7

ENABLE_CHECKPOINTS=true
CHECKPOINT_INTERVAL=10
CHECKPOINT_TTL_DAYS=7

ENABLE_RESOURCE_MANAGEMENT=true
IDLE_TIMEOUT_SECONDS=300
GPU_MEMORY_THRESHOLD_MB=14000
ENABLE_IDLE_MODE=true

# -----------------------------------------------------------------------------
# Testing (for local development only)
# -----------------------------------------------------------------------------
TESTING=false
TEST_REDIS_HOST=localhost
TEST_REDIS_PORT=6379
TEST_POSTGRES_HOST=localhost
TEST_POSTGRES_PORT=5432
